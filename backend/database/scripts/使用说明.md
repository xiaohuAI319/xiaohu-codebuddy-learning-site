# 数据库脚本使用说明

## 📋 脚本概述

本套数据库脚本为小虎CodeBuddy学习站提供完整的数据库重建和数据导入功能，支持快速恢复开发环境和部署测试数据。

## 📁 文件结构

```
backend/database/scripts/
├── 01_create_tables.sql          # 数据库表结构创建脚本
├── 02_membership_tiers_data.sql # 会员等级数据
├── 03_users_data.sql            # 用户数据
├── 04_works_data.sql            # 作品数据
├── 05_bootcamps_data.sql        # 训练营数据
├── 06_coupons_data.sql          # 优惠券数据
├── 07_serial_codes_data.sql     # 序列号数据
├── 08_votes_data.sql            # 投票数据
├── 99_import_all_data.sql       # 完整数据导入脚本
├── rebuild-database.sh           # Linux/Mac 重建脚本
├── rebuild-database.bat          # Windows 重建脚本
├── README.md                     # 英文说明文档
└── 使用说明.md                   # 本文档
```

## 🚀 快速开始

### Windows用户（推荐）

```cmd
# 方法1：使用npm脚本（最简单）
cd backend
npm run rebuild-db

# 方法2：使用批处理脚本
cd backend
database\scripts\rebuild-database.bat

# 方法3：手动执行
cd backend
del database\xiaohu-codebuddy.db
sqlite3 database\xiaohu-codebuddy.db < database\scripts\01_create_tables.sql
sqlite3 database\xiaohu-codebuddy.db < database\scripts\99_import_all_data.sql
```

### Linux/Mac用户

```bash
# 方法1：使用npm脚本
cd backend
npm run rebuild-db

# 方法2：使用shell脚本
cd backend
chmod +x database/scripts/rebuild-database.sh
./database/scripts/rebuild-database.sh

# 方法3：手动执行
cd backend
rm database/xiaohu-codebuddy.db
sqlite3 database/xiaohu-codebuddy.db < database/scripts/01_create_tables.sql
sqlite3 database/xiaohu-codebuddy.db < database/scripts/99_import_all_data.sql
```

## 📊 测试数据说明

### 用户账户
| 角色 | 用户名 | 密码 | 权限 |
|------|--------|------|------|
| 管理员 | admin@xiaohu.com | admin123456 | 全部权限 |
| 测试用户 | testuser@example.com | *[见数据库]* | 基础学员 |
| 普通学员 | student@example.com | *[见数据库]* | 基础学员 |

### 作品数据（5个测试作品）
1. **AI聊天机器人** - 40票，置顶作品
2. **图片识别应用** - 47票，AI相关
3. **任务管理系统** - 21票，团队协作
4. **天气应用** - 2票，移动端
5. **代码编辑器** - 5票，开发工具

### 会员等级（5个等级）
- 学员 → 会员 → 高级会员 → 共创 → 讲师

### 其他数据
- 训练营：3个（AI编程、Web全栈、移动开发）
- 优惠券：3种（欢迎券、春季券、学生券）
- 序列号：25个升级码（每个等级5个）
- 投票记录：2条测试记录

## 🛠️ 可用命令

```bash
# 重建完整数据库（结构+数据）
npm run rebuild-db

# 只导入数据（保留表结构）
npm run import-data

# 导出数据库备份
npm run export-db

# 传统初始化（使用TypeScript脚本）
npm run init-db

# 创建测试作品
npm run create-test-works
```

## 🔧 高级用法

### 备份现有数据库
```bash
# 自动备份（带时间戳）
npm run export-db

# 手动备份
cp database/xiaohu-codebuddy.db database/xiaohu-codebuddy.db.backup.$(date +%Y%m%d_%H%M%S)
```

### 验证数据库状态
```bash
# 查看表结构
sqlite3 database/xiaohu-codebuddy.db ".schema"

# 查看数据统计
sqlite3 database/xiaohu-codebuddy.db "SELECT 'users:' || COUNT(*) FROM users UNION SELECT 'works:' || COUNT(*) FROM works UNION SELECT 'votes:' || COUNT(*) FROM votes;"
```

### 自定义数据修改
编辑 `99_import_all_data.sql` 文件中的相应部分，然后重新导入：
```bash
npm run import-data
```

## 🚨 注意事项

1. **数据丢失警告**: 执行重建脚本会清空所有现有数据
2. **备份建议**: 重建前会自动备份原数据库文件
3. **密码安全**: 测试用户密码需要根据实际bcrypt哈希值调整
4. **文件权限**: 确保对database目录有读写权限
5. **端口冲突**: 重建后需要重启后端服务

## 🐛 常见问题

### Q: 重建后无法登录？
A: 检查密码哈希值是否正确，或使用默认管理员账户 admin@xiaohu.com / admin123456

### Q: 投票功能不工作？
A: 确保votes表数据正确导入，检查数据库关联关系

### Q: 作品图片显示错误？
A: 检查uploads目录是否存在对应图片文件

### Q: 数据库文件被占用？
A: 停止后端服务后重试，或重启电脑

## 📈 数据统计

执行重建后，数据库应包含：
- 会员等级: 5条
- 用户: 3条
- 作品: 5条
- 训练营: 3条
- 优惠券: 3条
- 序列号: 25条
- 投票记录: 2条

---

**创建时间**: 2025-09-27
**维护者**: Claude AI Assistant
**适用版本**: 小虎CodeBuddy学习站 v1.0